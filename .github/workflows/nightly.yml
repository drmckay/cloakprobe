name: Nightly Release

on:
  schedule:
    # Run at 04:00 UTC every day
    - cron: '0 4 * * *'
  workflow_dispatch:
    # Allow manual trigger

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Build (native)
        if: ${{ !matrix.cross }}
        run: |
          cargo build --release --target ${{ matrix.target }}
          cargo build --release --target ${{ matrix.target }} --bin asn_builder
          cargo build --release --target ${{ matrix.target }} --bin org_builder
          cargo build --release --target ${{ matrix.target }} --bin org_builder_rpsl
          cargo build --release --target ${{ matrix.target }} --bin org_builder_arin

      - name: Build (cross)
        if: matrix.cross
        run: |
          cross build --release --target ${{ matrix.target }}
          cross build --release --target ${{ matrix.target }} --bin asn_builder
          cross build --release --target ${{ matrix.target }} --bin org_builder
          cross build --release --target ${{ matrix.target }} --bin org_builder_rpsl
          cross build --release --target ${{ matrix.target }} --bin org_builder_arin

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/cloakprobe
            target/${{ matrix.target }}/release/asn_builder
            target/${{ matrix.target }}/release/org_builder
            target/${{ matrix.target }}/release/org_builder_rpsl
            target/${{ matrix.target }}/release/org_builder_arin

  build-databases:
    name: Build Databases
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-db-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-db-

      - name: Build database builders
        run: |
          cargo build --release --bin asn_builder

      - name: Download ip2asn database
        run: |
          mkdir -p data
          for i in 1 2 3 4 5; do
            echo "Attempt $i: Downloading ip2asn database..."
            if curl -sSfL --connect-timeout 30 --max-time 120 \
              "https://iptoasn.com/data/ip2asn-combined.tsv.gz" \
              -o data/ip2asn-combined.tsv.gz; then
              echo "Download successful"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "Failed to download after 5 attempts"
              exit 1
            fi
            echo "Download failed, retrying in $((2**i)) seconds..."
            sleep $((2**i))
          done
          gunzip -c data/ip2asn-combined.tsv.gz > data/ip2asn-combined.tsv

      - name: Build ASN database
        run: ./target/release/asn_builder data/ip2asn-combined.tsv data/asn_db.bin

      - name: Upload databases
        uses: actions/upload-artifact@v4
        with:
          name: databases
          path: |
            data/asn_db.bin

  package:
    name: Package ${{ matrix.target }}
    needs: [build, build-databases]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: binaries

      - name: Download databases
        uses: actions/download-artifact@v4
        with:
          name: databases
          path: databases

      - name: Create package
        run: |
          PACKAGE_DIR="cloakprobe-${{ matrix.target }}"
          mkdir -p "${PACKAGE_DIR}/data"
          mkdir -p "${PACKAGE_DIR}/scripts"
          mkdir -p "${PACKAGE_DIR}/systemd"
          mkdir -p "${PACKAGE_DIR}/templates"
          mkdir -p "${PACKAGE_DIR}/docs"
          
          # Copy binaries
          cp binaries/cloakprobe "${PACKAGE_DIR}/"
          cp binaries/asn_builder "${PACKAGE_DIR}/"
          cp binaries/org_builder "${PACKAGE_DIR}/"
          cp binaries/org_builder_rpsl "${PACKAGE_DIR}/"
          cp binaries/org_builder_arin "${PACKAGE_DIR}/"
          chmod +x "${PACKAGE_DIR}/cloakprobe"
          chmod +x "${PACKAGE_DIR}/asn_builder"
          chmod +x "${PACKAGE_DIR}/org_builder"
          chmod +x "${PACKAGE_DIR}/org_builder_rpsl"
          chmod +x "${PACKAGE_DIR}/org_builder_arin"
          
          # Copy databases (ASN only, org DB is built after installation)
          cp databases/asn_db.bin "${PACKAGE_DIR}/data/"
          
          # Copy scripts
          cp scripts/update_asn_db.sh "${PACKAGE_DIR}/scripts/"
          cp scripts/update_org_db.sh "${PACKAGE_DIR}/scripts/"
          cp scripts/download_rir_orgs.sh "${PACKAGE_DIR}/scripts/"
          chmod +x "${PACKAGE_DIR}/scripts/"*.sh
          
          # Copy systemd services
          cp systemd/cloakprobe.service "${PACKAGE_DIR}/systemd/"
          cp systemd/cloakprobe@.service "${PACKAGE_DIR}/systemd/"
          
          # Copy templates
          cp -r templates/* "${PACKAGE_DIR}/templates/"
          
          # Copy configuration
          cp cloakprobe.example.toml "${PACKAGE_DIR}/"
          
          # Copy documentation
          cp README.md "${PACKAGE_DIR}/"
          cp -r docs/* "${PACKAGE_DIR}/docs/" 2>/dev/null || true
          
          # Create tarball
          tar -czvf "cloakprobe-${{ matrix.target }}.tar.gz" "${PACKAGE_DIR}"

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.target }}
          path: cloakprobe-${{ matrix.target }}.tar.gz

  release:
    name: Create Nightly Release
    needs: package
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download x86_64 package
        uses: actions/download-artifact@v4
        with:
          name: package-x86_64-unknown-linux-gnu
          path: packages

      - name: Download aarch64 package
        uses: actions/download-artifact@v4
        with:
          name: package-aarch64-unknown-linux-gnu
          path: packages

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Setup git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Delete previous nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete release and its tag together
          if gh release view nightly >/dev/null 2>&1; then
            echo "Release 'nightly' exists, deleting with tag..."
            gh release delete nightly --cleanup-tag --yes || true
          else
            echo "Release 'nightly' does not exist"
            # Still try to delete orphan tag if it exists
            gh api repos/${{ github.repository }}/git/refs/tags/nightly -X DELETE 2>/dev/null || true
          fi
        continue-on-error: true

      - name: Create release notes
        run: |
          cat <<'EOF' > release_notes.md
          ## Nightly Build - ${{ steps.date.outputs.date }}

          This is an automated nightly build containing the latest code and updated databases.

          ### Contents

          Each package includes:
          - `cloakprobe` - Main binary
          - `asn_builder` - ASN database builder
          - `org_builder`, `org_builder_rpsl`, `org_builder_arin` - Multi-RIR organization database builders
          - `cloakprobe.example.toml` - Example configuration file
          - `data/asn_db.bin` - Pre-built ASN database (from iptoasn.com)
          - `templates/` - HTML templates (index.html.tera, privacy.html.tera)
          - `scripts/` - Database update scripts (including multi-RIR org update)
          - `systemd/` - Systemd service files (single and multi-instance)
          - `docs/` - Deployment documentation (nginx setup guide)
          
          > **Note**: Multi-RIR organization database is not pre-built. Run `update_org_db.sh` after installation.

          ### Installation

          ```bash
          # Download and extract
          tar -xzf cloakprobe-x86_64-unknown-linux-gnu.tar.gz
          cd cloakprobe-x86_64-unknown-linux-gnu

          # Copy and edit configuration
          sudo mkdir -p /etc/cloakprobe
          sudo cp cloakprobe.example.toml /etc/cloakprobe/cloakprobe.toml
          sudo nano /etc/cloakprobe/cloakprobe.toml

          # Run
          ./cloakprobe -c /etc/cloakprobe/cloakprobe.toml
          ```

          For full installation instructions, see the README and docs/nginx-deployment.md.

          ---
          ⚠️ **Note**: This is a pre-release build. Use at your own risk.
          EOF

      - name: Create nightly release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "nightly-$(date -u +%Y%m%d)" \
            packages/cloakprobe-x86_64-unknown-linux-gnu.tar.gz \
            packages/cloakprobe-aarch64-unknown-linux-gnu.tar.gz \
            --title "Nightly Build ($(date -u +%Y-%m-%d))" \
            --notes-file release_notes.md \
            --prerelease

