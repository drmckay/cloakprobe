<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CloakProbe - {{ ip }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="CloakProbe - Your IP address and network information">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='13' cy='13' r='10' fill='none' stroke='%23f9fafb' stroke-width='2.5'/%3E%3Cline x1='20.5' y1='20.5' x2='29' y2='29' stroke='%23f9fafb' stroke-width='3' stroke-linecap='round'/%3E%3Cellipse cx='13' cy='9' rx='4.5' ry='2.2' fill='%23f9fafb'/%3E%3Cpath d='M13 11.5c-2.5 0-4 1.2-4 2.8v0.5c0 0.3 0.2 0.5 0.5 0.5h7c0.3 0 0.5-0.2 0.5-0.5v-0.5c0-1.6-1.5-2.8-4-2.8z' fill='%23f9fafb'/%3E%3Cpath d='M9.5 15.5c-0.8 0.5-1.5 1.5-1.5 2.5v1h10v-1c0-1-0.7-2-1.5-2.5' fill='%23f9fafb'/%3E%3C/svg%3E">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      color-scheme: dark;
      --bg-gradient-start: #0f172a;
      --bg-gradient-end: #020617;
      --card-bg: rgba(15, 23, 42, 0.95);
      --card-border: rgba(148, 163, 184, 0.2);
      --text-primary: #f9fafb;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-primary: #22c55e;
      --accent-secondary: #0ea5e9;
      --accent-gradient: linear-gradient(135deg, #22c55e, #0ea5e9);
      --section-bg: rgba(30, 41, 59, 0.5);
    }
    body {
      background: radial-gradient(ellipse at top, var(--bg-gradient-start), var(--bg-gradient-end));
      color: var(--text-primary);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
      padding: 2rem 1rem;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 3rem;
    }
    .header h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }
    .header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }
    .ip-display {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 1.5rem;
      padding: 3rem 2rem;
      text-align: center;
      margin-bottom: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .ip-label {
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      font-weight: 600;
    }
    .ip-value-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      max-width: 100%;
      flex-wrap: wrap;
    }
    .ip-value {
      font-size: clamp(1.5rem, 5vw, 4rem);
      font-weight: 700;
      font-family: "SF Mono", "Monaco", "Cascadia Code", monospace;
      word-break: break-all;
      overflow-wrap: anywhere;
      max-width: 100%;
    }
    .copy-btn {
      background: var(--section-bg);
      border: 1px solid var(--card-border);
      border-radius: 0.5rem;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .copy-btn:hover {
      background: var(--card-border);
      color: var(--text-primary);
    }
    .copy-btn:active {
      transform: scale(0.95);
    }
    .copy-btn.copied {
      background: rgba(34, 197, 94, 0.2);
      color: var(--accent-primary);
      border-color: var(--accent-primary);
    }
    .copy-btn svg {
      width: 1.25rem;
      height: 1.25rem;
    }
    .ip-version {
      display: inline-block;
      background: var(--section-bg);
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }
    .reverse-dns-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .reverse-dns-btn {
      background: var(--section-bg);
      border: 1px solid var(--card-border);
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .reverse-dns-btn:hover:not(:disabled) {
      background: var(--card-border);
      color: var(--text-primary);
    }
    .reverse-dns-btn:active:not(:disabled) {
      transform: scale(0.95);
    }
    .reverse-dns-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .reverse-dns-btn.loading {
      position: relative;
    }
    .reverse-dns-btn svg {
      width: 1rem;
      height: 1rem;
    }
    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--card-border);
      border-top-color: var(--accent-secondary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .card-title {
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 1rem;
      font-weight: 600;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      flex: 0 0 40%;
    }
    .info-value {
      color: var(--text-primary);
      font-size: 0.9rem;
      text-align: right;
      flex: 1;
      font-weight: 500;
      word-break: break-word;
    }
    .info-value code {
      background: var(--section-bg);
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-family: "SF Mono", "Monaco", "Cascadia Code", monospace;
      font-size: 0.85em;
    }
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--section-bg);
      color: var(--text-secondary);
    }
    .badge-success {
      background: rgba(34, 197, 94, 0.2);
      color: var(--accent-primary);
    }
    .badge-info {
      background: rgba(14, 165, 233, 0.2);
      color: var(--accent-secondary);
    }
    .footer {
      text-align: center;
      padding: 2rem 0;
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    .footer a {
      color: var(--accent-secondary);
      text-decoration: none;
    }
    .footer a:hover {
      text-decoration: underline;
    }
    .empty-state {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
    }
    .dns-separator {
      color: var(--text-muted);
      font-size: 3rem;
      font-weight: 200;
      align-self: center;
      padding: 0 1.5rem;
      line-height: 1;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .ip-display {
        padding: 2rem 1.5rem;
      }
      .dns-separator {
        display: none !important;
      }
      }
      body {
        padding: 1rem 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>CloakProbe</h1>
      <p>Your network details and connection information</p>
      <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
        <a href="https://cloakprobe.dev" style="color: var(--accent-secondary); text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          cloakprobe.dev
        </a>
        <span style="color: var(--text-muted);">•</span>
        <a href="https://github.com/drmckay/cloakprobe" target="_blank" rel="noopener noreferrer" style="color: var(--accent-secondary); text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
          </svg>
          GitHub
        </a>
      </div>
    </div>

    <div class="ip-display">
      <div class="ip-label">Your Public IP Address</div>
      <div class="ip-value-container">
        <div class="ip-value" id="ip-value">{{ ip }}</div>
        <button class="copy-btn" onclick="copyIP()" title="Copy to clipboard">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        </button>
      </div>
      <div class="ip-version">IPv{{ ip_version }} • <span class="badge badge-info">{{ ip_type }}</span></div>
      <div class="reverse-dns-container" style="margin-top: 1.5rem;">
        <button class="reverse-dns-btn" id="reverse-dns-btn" onclick="lookupReverseDNS()" title="Lookup reverse DNS (PTR record)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span id="reverse-dns-btn-text">Lookup Reverse DNS</span>
        </button>
      </div>
      <div id="reverse-dns-result-container" style="display: none; margin-top: 1.5rem;">
        <div style="display: flex; align-items: flex-start; gap: 2rem; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 250px;">
            <div class="ip-label">Reverse DNS (PTR)</div>
            <div class="ip-value-container">
              <div class="ip-value" id="reverse-dns-value" style="font-size: clamp(1.5rem, 4vw, 2.5rem);"></div>
              <button class="copy-btn" id="reverse-dns-copy-btn" onclick="copyHostname()" title="Copy to clipboard" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
              </button>
            </div>
          </div>
          <div id="dns-separator" class="dns-separator" style="display: none;">|</div>
          <div id="ns-hint-wrapper" style="display: none; flex: 1; min-width: 250px;">
            <div class="ip-label">Authoritative NS (ISP Hint)</div>
            <div class="ip-value" id="ns-hint-value" style="font-size: clamp(1rem, 3vw, 1.75rem); color: var(--accent-secondary); margin-bottom: 0.5rem;"></div>
            <div id="ns-hint-details" style="font-size: 0.85rem; color: var(--text-muted);"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-title">IP Address Details</div>
        {% if ip_version == 4 %}
        <div class="info-row">
          <span class="info-label">Dotted Decimal</span>
          <span class="info-value"><code>{{ ip_primary }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Hexadecimal</span>
          <span class="info-value"><code>{{ ip_hex }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Binary Format</span>
          <span class="info-value"><code style="font-size: 0.75em;">{{ ip_binary }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Numeric (u32)</span>
          <span class="info-value"><code>{{ ip_numeric }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">/24 Subnet</span>
          <span class="info-value"><code>{{ ip_subnet }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Subnet Size</span>
          <span class="info-value"><code>{{ ip_subnet_size }}</code></span>
        </div>
        {% else %}
        <div class="info-row">
          <span class="info-label">Standard Notation</span>
          <span class="info-value"><code>{{ ip_primary }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Full Expanded</span>
          <span class="info-value"><code style="font-size: 0.8em;">{{ ip_expanded }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Binary Format</span>
          <span class="info-value"><code style="font-size: 0.6em; word-break: break-all;">{{ ip_binary }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">/64 Network</span>
          <span class="info-value"><code style="font-size: 0.85em;">{{ ip_subnet }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Network Size</span>
          <span class="info-value"><code>{{ ip_subnet_size }}</code></span>
        </div>
        {% endif %}
        <div class="info-row">
          <span class="info-label">Address Type</span>
          <span class="info-value"><span class="badge badge-info">{{ ip_type }}</span></span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Network Information</div>
        <div class="info-row">
          <span class="info-label">ASN</span>
          <span class="info-value"><code>{{ asn }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">AS Name</span>
          <span class="info-value"><code>{{ as_name }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Network Prefix</span>
          <span class="info-value"><code>{{ prefix }}</code></span>
        </div>
        {% if org_rir != "—" %}
        <div class="info-row">
          <span class="info-label">RIR</span>
          <span class="info-value"><code>{{ org_rir }}</code></span>
        </div>
        {% endif %}
        <div class="info-row">
          <span class="info-label">Country Code</span>
          <span class="info-value"><code>{{ country }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Organization</span>
          <span class="info-value"><code>{{ org_name }}</code></span>
        </div>
        {% if org_id != "—" %}
        <div class="info-row">
          <span class="info-label">Org ID</span>
          <span class="info-value"><code>{{ org_id }}</code></span>
        </div>
        {% endif %}
        {% if org_type != "—" %}
        <div class="info-row">
          <span class="info-label">Org Type</span>
          <span class="info-value"><code>{{ org_type }}</code></span>
        </div>
        {% endif %}
        {% if abuse_contact != "—" %}
        <div class="info-row">
          <span class="info-label">Abuse Contact</span>
          <span class="info-value"><code>{{ abuse_contact }}</code></span>
        </div>
        {% endif %}
        {% if org_last_updated != "—" %}
        <div class="info-row">
          <span class="info-label">Org Last Updated</span>
          <span class="info-value"><code>{{ org_last_updated }}</code></span>
        </div>
        {% endif %}
      </div>

      <div class="card">
        <div class="card-title">Connection Details</div>
        <div class="info-row">
          <span class="info-label">TLS Version</span>
          <span class="info-value"><code>{{ tls_version }}</code></span>
        </div>
        {% if tls_cipher != "—" %}
        <div class="info-row">
          <span class="info-label">TLS Cipher</span>
          <span class="info-value"><code>{{ tls_cipher }}</code></span>
        </div>
        {% endif %}
        <div class="info-row">
          <span class="info-label">HTTP Protocol</span>
          <span class="info-value"><code>{{ http_protocol }}</code></span>
        </div>
        {% if cf_ray != "—" %}
        <div class="info-row">
          <span class="info-label">CF-Ray</span>
          <span class="info-value"><code>{{ cf_ray }}</code></span>
        </div>
        {% endif %}
        {% if datacenter != "—" %}
        <div class="info-row">
          <span class="info-label">Datacenter</span>
          <span class="info-value"><code>{{ datacenter }}</code></span>
        </div>
        {% endif %}
        {% if cf_request_id != "—" %}
        <div class="info-row">
          <span class="info-label">CF-Request-ID</span>
          <span class="info-value"><code>{{ cf_request_id }}</code></span>
        </div>
        {% endif %}
        {% if cf_cache_status != "—" %}
        <div class="info-row">
          <span class="info-label">CF-Cache-Status</span>
          <span class="info-value"><code>{{ cf_cache_status }}</code></span>
        </div>
        {% endif %}
        {# Nginx-specific connection fields #}
        {% if not is_cloudflare_mode %}
        {% if request_id != "—" %}
        <div class="info-row">
          <span class="info-label">Request ID</span>
          <span class="info-value"><code>{{ request_id }}</code></span>
        </div>
        {% endif %}
        {% if remote_port != "—" %}
        <div class="info-row">
          <span class="info-label">Client Port</span>
          <span class="info-value"><code>{{ remote_port }}</code></span>
        </div>
        {% endif %}
        {% if connection_id != "—" %}
        <div class="info-row">
          <span class="info-label">Connection ID</span>
          <span class="info-value"><code>{{ connection_id }}</code></span>
        </div>
        {% endif %}
        {% endif %}
      </div>

      {# Nginx GeoIP Card (only in nginx mode with GeoIP data) #}
      {% if not is_cloudflare_mode %}
      {% if geoip_country != "—" or geoip_city != "—" or geoip_region != "—" %}
      <div class="card">
        <div class="card-title">Geo Location (GeoIP)</div>
        {% if geoip_country != "—" %}
        <div class="info-row">
          <span class="info-label">Country</span>
          <span class="info-value"><code>{{ geoip_country }}</code></span>
        </div>
        {% endif %}
        {% if geoip_city != "—" %}
        <div class="info-row">
          <span class="info-label">City</span>
          <span class="info-value"><code>{{ geoip_city }}</code></span>
        </div>
        {% endif %}
        {% if geoip_region != "—" %}
        <div class="info-row">
          <span class="info-label">Region</span>
          <span class="info-value"><code>{{ geoip_region }}</code></span>
        </div>
        {% endif %}
        {% if geoip_latitude != "—" and geoip_longitude != "—" %}
        <div class="info-row">
          <span class="info-label">Coordinates</span>
          <span class="info-value"><code>{{ geoip_latitude }}, {{ geoip_longitude }}</code></span>
        </div>
        {% endif %}
        {% if geoip_postal_code != "—" %}
        <div class="info-row">
          <span class="info-label">Postal Code</span>
          <span class="info-value"><code>{{ geoip_postal_code }}</code></span>
        </div>
        {% endif %}
        {% if geoip_org != "—" %}
        <div class="info-row">
          <span class="info-label">Organization</span>
          <span class="info-value"><code>{{ geoip_org }}</code></span>
        </div>
        {% endif %}
      </div>
      {% endif %}
      {% endif %}

      {% if is_cloudflare_mode %}
      <div class="card">
        <div class="card-title">Cloudflare Headers</div>
        {% if geo_location_items %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">--- Geo Location ---</div>
          {% for item in geo_location_items %}
          <div class="info-row">
            <span class="info-label">{{ item.label }}</span>
            <span class="info-value"><code>{{ item.value }}</code></span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% if network_items %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">--- Network ---</div>
          {% for item in network_items %}
          <div class="info-row">
            <span class="info-label">{{ item.label }}</span>
            <span class="info-value"><code>{{ item.value }}</code></span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% if connection_items %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">--- Connection ---</div>
          {% for item in connection_items %}
          <div class="info-row">
            <span class="info-label">{{ item.label }}</span>
            <span class="info-value"><code>{{ item.value }}</code></span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% if security_items %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">--- Security ---</div>
          {% for item in security_items %}
          <div class="info-row">
            <span class="info-label">{{ item.label }}</span>
            <span class="info-value"><code>{{ item.value }}</code></span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        {% if proxy_items %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">--- Proxy Headers ---</div>
          {% for item in proxy_items %}
          <div class="info-row">
            <span class="info-label">{{ item.label }}</span>
            <span class="info-value"><code>{{ item.value }}</code></span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% else %}
      {# Nginx mode: Show only proxy headers if available #}
      {% if proxy_items %}
      <div class="card">
        <div class="card-title">Proxy Headers</div>
        {% for item in proxy_items %}
        <div class="info-row">
          <span class="info-label">{{ item.label }}</span>
          <span class="info-value"><code>{{ item.value }}</code></span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      {% endif %}

      <div class="card">
        <div class="card-title">Client Information</div>
        <div class="info-row">
          <span class="info-label">User-Agent</span>
          <span class="info-value"><code style="font-size: 0.8em;">{{ user_agent }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Accept-Language</span>
          <span class="info-value"><code>{{ accept_language }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Accept-Encoding</span>
          <span class="info-value"><code>{{ accept_encoding }}</code></span>
        </div>
        {% if referer != "—" %}
        <div class="info-row">
          <span class="info-label">Referer</span>
          <span class="info-value"><code style="font-size: 0.8em;">{{ referer }}</code></span>
        </div>
        {% endif %}
        {% if origin != "—" %}
        <div class="info-row">
          <span class="info-label">Origin</span>
          <span class="info-value"><code>{{ origin }}</code></span>
        </div>
        {% endif %}

        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">--- Privacy ---</div>
          <div class="info-row">
            <span class="info-label">DNT (Do Not Track)</span>
            <span class="info-value"><code>{{ dnt }}</code></span>
          </div>
          <div class="info-row">
            <span class="info-label">Sec-GPC (Global Privacy Control)</span>
            <span class="info-value"><code>{{ sec_gpc }}</code></span>
          </div>
          {% if save_data != "—" %}
          <div class="info-row">
            <span class="info-label">Save-Data</span>
            <span class="info-value"><code>{{ save_data }}</code></span>
          </div>
          {% endif %}
          {% if upgrade_insecure_requests != "—" %}
          <div class="info-row">
            <span class="info-label">Upgrade-Insecure-Requests</span>
            <span class="info-value"><code>{{ upgrade_insecure_requests }}</code></span>
          </div>
          {% endif %}
        </div>

        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">--- Client Hints ---</div>
          <div class="info-row">
            <span class="info-label">Sec-CH-UA</span>
            <span class="info-value"><code style="font-size: 0.8em;">{{ sec_ch_ua }}</code></span>
          </div>
          <div class="info-row">
            <span class="info-label">Sec-CH-UA-Platform</span>
            <span class="info-value"><code>{{ sec_ch_ua_platform }}</code></span>
          </div>
          {% if sec_ch_ua_mobile != "—" %}
          <div class="info-row">
            <span class="info-label">Sec-CH-UA-Mobile</span>
            <span class="info-value"><code>{{ sec_ch_ua_mobile }}</code></span>
          </div>
          {% endif %}
          {% if sec_ch_ua_full_version_list != "—" %}
          <div class="info-row">
            <span class="info-label">Sec-CH-UA-Full-Version-List</span>
            <span class="info-value"><code style="font-size: 0.75em;">{{ sec_ch_ua_full_version_list }}</code></span>
          </div>
          {% endif %}
          {% if device_memory != "—" %}
          <div class="info-row">
            <span class="info-label">Device-Memory</span>
            <span class="info-value"><code>{{ device_memory }} GB</code></span>
          </div>
          {% endif %}
          {% if viewport_width != "—" %}
          <div class="info-row">
            <span class="info-label">Viewport-Width</span>
            <span class="info-value"><code>{{ viewport_width }}px</code></span>
          </div>
          {% endif %}
          {% if downlink != "—" or rtt != "—" or ect != "—" %}
          <div class="info-row">
            <span class="info-label">Network Info</span>
            <span class="info-value"><code>{% if downlink != "—" %}{{ downlink }} Mbps{% endif %}{% if rtt != "—" %} / {{ rtt }}ms RTT{% endif %}{% if ect != "—" %} ({{ ect }}){% endif %}</code></span>
          </div>
          {% endif %}
        </div>

        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">--- Sec-Fetch ---</div>
          {% if sec_fetch_site != "—" %}
          <div class="info-row">
            <span class="info-label">Sec-Fetch-Site</span>
            <span class="info-value"><code>{{ sec_fetch_site }}</code></span>
          </div>
          {% endif %}
          {% if sec_fetch_mode != "—" %}
          <div class="info-row">
            <span class="info-label">Sec-Fetch-Mode</span>
            <span class="info-value"><code>{{ sec_fetch_mode }}</code></span>
          </div>
          {% endif %}
          {% if sec_fetch_dest != "—" %}
          <div class="info-row">
            <span class="info-label">Sec-Fetch-Dest</span>
            <span class="info-value"><code>{{ sec_fetch_dest }}</code></span>
          </div>
          {% endif %}
          {% if sec_fetch_user != "—" %}
          <div class="info-row">
            <span class="info-label">Sec-Fetch-User</span>
            <span class="info-value"><code>{{ sec_fetch_user }}</code></span>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-title">Server Information</div>
        <div class="info-row">
          <span class="info-label">Timestamp</span>
          <span class="info-value"><code>{{ timestamp }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Version</span>
          <span class="info-value"><code>{{ version }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Region</span>
          <span class="info-value"><code>{{ region }}</code></span>
        </div>
        <div class="info-row">
          <span class="info-label">Privacy Mode</span>
          <span class="info-value"><span class="badge badge-success">{{ privacy_mode }}</span></span>
        </div>
        <div class="info-row">
          <span class="info-label">Response Time</span>
          <span class="info-value"><code>{{ response_time_ms }} ms</code></span>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>API endpoints: <a href="/api/v1/json">JSON</a> | <a href="/api/v1/plain">Plain text</a> | <a href="/healthz">Health</a></p>
      <p style="margin-top: 0.5rem;">No tracking • No ads • Privacy-focused</p>
      <p style="margin-top: 1rem;">
        <a href="/privacy" style="color: var(--accent-secondary); text-decoration: none;">Privacy Policy</a>
        <span style="color: var(--text-muted); margin: 0 0.75rem;">•</span>
        <a href="https://cloakprobe.dev" style="color: var(--accent-secondary); text-decoration: none;">← Back to cloakprobe.dev</a>
        <span style="color: var(--text-muted); margin: 0 0.75rem;">•</span>
        <a href="https://github.com/drmckay/cloakprobe" target="_blank" rel="noopener noreferrer" style="color: var(--accent-secondary); text-decoration: none;">View on GitHub</a>
      </p>
    </div>
  </div>
  <script>
    function copyIP() {
      const ip = document.getElementById('ip-value').textContent;
      navigator.clipboard.writeText(ip).then(function() {
        const btn = document.querySelector('.copy-btn');
        btn.classList.add('copied');
        setTimeout(function() {
          btn.classList.remove('copied');
        }, 1500);
      });
    }

    // Convert IP address to reverse DNS format
    function ipToReverseDNS(ip) {
      // Check if IPv4 or IPv6
      if (ip.includes('.')) {
        // IPv4: Reverse octets and append .in-addr.arpa
        const parts = ip.split('.').reverse();
        return parts.join('.') + '.in-addr.arpa';
      } else if (ip.includes(':')) {
        // IPv6: Expand, reverse hex digits, append .ip6.arpa
        // Expand IPv6 to full form
        const expandIPv6 = (ip) => {
          const parts = ip.split('::');
          if (parts.length === 2) {
            const left = parts[0].split(':').filter(p => p);
            const right = parts[1].split(':').filter(p => p);
            const missing = 8 - left.length - right.length;
            const zeros = Array(missing).fill('0');
            return [...left, ...zeros, ...right].map(p => p.padStart(4, '0'));
          } else {
            return ip.split(':').map(p => p.padStart(4, '0'));
          }
        };
        
        const expanded = expandIPv6(ip);
        // Reverse each hex digit in each segment
        const reversed = expanded
          .join('')
          .split('')
          .reverse()
          .join('.');
        return reversed + '.ip6.arpa';
      }
      return null;
    }

    // Get reverse DNS zone for NS lookup (different from PTR query name)
    function getReverseDNSZone(ip) {
      if (ip.includes('.')) {
        // IPv4: For NS lookup we need the zone, not full PTR name
        // e.g., for 8.8.8.8 -> try 8.8.8.in-addr.arpa first
        const parts = ip.split('.').reverse();
        return parts.slice(1).join('.') + '.in-addr.arpa';
      } else if (ip.includes(':')) {
        // IPv6: Get zone (typically /48 or /32 delegation)
        const expandIPv6 = (ip) => {
          const parts = ip.split('::');
          if (parts.length === 2) {
            const left = parts[0].split(':').filter(p => p);
            const right = parts[1].split(':').filter(p => p);
            const missing = 8 - left.length - right.length;
            const zeros = Array(missing).fill('0');
            return [...left, ...zeros, ...right].map(p => p.padStart(4, '0'));
          } else {
            return ip.split(':').map(p => p.padStart(4, '0'));
          }
        };
        
        const expanded = expandIPv6(ip);
        // For IPv6, typically try /48 zone (first 12 nibbles)
        const nibbles = expanded.join('').split('').reverse();
        return nibbles.slice(20).join('.') + '.ip6.arpa';
      }
      return null;
    }

    // Extract ISP hint from NS hostname
    function extractISPHint(nsHostname) {
      // Remove trailing dot if present
      let host = nsHostname.replace(/\.$/, '').toLowerCase();
      
      // Extract main domain (last 2-3 parts depending on TLD)
      const parts = host.split('.');
      if (parts.length < 2) return host;
      
      // Check for common ccTLDs with second-level domains (co.uk, com.au, etc.)
      const twoPartTLDs = ['co.uk', 'com.au', 'co.jp', 'com.br', 'co.nz', 'co.za', 'org.uk', 'net.au'];
      const lastTwo = parts.slice(-2).join('.');
      
      if (twoPartTLDs.includes(lastTwo) && parts.length >= 3) {
        return parts.slice(-3).join('.');
      }
      
      return parts.slice(-2).join('.');
    }

    // Lookup authoritative NS for the IP's reverse zone
    async function lookupAuthoritativeNS(ip) {
      const nsWrapper = document.getElementById('ns-hint-wrapper');
      const nsValue = document.getElementById('ns-hint-value');
      const nsDetails = document.getElementById('ns-hint-details');
      const separator = document.getElementById('dns-separator');
      
      nsWrapper.style.display = 'none';
      separator.style.display = 'none';
      
      try {
        const zone = getReverseDNSZone(ip);
        if (!zone) return;
        
        // Query NS records for the zone
        const dohUrl = `https://cloudflare-dns.com/dns-query?name=${encodeURIComponent(zone)}&type=NS`;
        const response = await fetch(dohUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/dns-json' }
        });
        
        if (!response.ok) return;
        
        const data = await response.json();
        
        if (data.Answer && data.Answer.length > 0) {
          // Get unique ISP hints from all NS records
          const nsHostnames = data.Answer.map(a => a.data);
          const ispHints = [...new Set(nsHostnames.map(extractISPHint))];
          
          // Filter out generic/unhelpful hints
          const filteredHints = ispHints.filter(h => 
            !h.includes('in-addr.arpa') && 
            !h.includes('ip6.arpa') &&
            !h.includes('cloudflare.com') &&
            !h.includes('ripe.net') &&
            h.length > 0
          );
          
          if (filteredHints.length > 0) {
            nsValue.textContent = filteredHints.join(' • ');
            nsValue.style.color = 'var(--accent-secondary)';
            nsDetails.textContent = 'NS: ' + nsHostnames.slice(0, 3).join(', ');
            nsWrapper.style.display = 'block';
            separator.style.display = 'block';
          }
        } else if (data.Authority && data.Authority.length > 0) {
          // SOA record may be in Authority section
          const soaData = data.Authority.find(a => a.type === 6);
          if (soaData && soaData.data) {
            const primaryNS = soaData.data.split(' ')[0];
            const ispHint = extractISPHint(primaryNS);
            if (ispHint && !ispHint.includes('arpa')) {
              nsValue.textContent = ispHint;
              nsValue.style.color = 'var(--accent-secondary)';
              nsDetails.textContent = 'Primary NS: ' + primaryNS;
              nsWrapper.style.display = 'block';
              separator.style.display = 'block';
            }
          }
        }
      } catch (error) {
        // Silently fail - NS hint is supplementary info
        console.log('NS lookup failed:', error);
      }
    }

    async function lookupReverseDNS() {
      const ip = document.getElementById('ip-value').textContent.trim();
      const btn = document.getElementById('reverse-dns-btn');
      const btnText = document.getElementById('reverse-dns-btn-text');
      const resultContainer = document.getElementById('reverse-dns-result-container');
      const resultValue = document.getElementById('reverse-dns-value');
      const copyBtn = document.getElementById('reverse-dns-copy-btn');
      const nsWrapper = document.getElementById('ns-hint-wrapper');
      const separator = document.getElementById('dns-separator');
      
      // Disable button and show loading
      btn.disabled = true;
      btn.classList.add('loading');
      btnText.innerHTML = '<span class="spinner"></span> Looking up...';
      resultContainer.style.display = 'none';
      copyBtn.style.display = 'none';
      nsWrapper.style.display = 'none';
      separator.style.display = 'none';
      
      // Run PTR and NS lookups in parallel
      const ptrPromise = (async () => {
        // Convert IP to reverse DNS format
        const reverseDNS = ipToReverseDNS(ip);
        if (!reverseDNS) {
          throw new Error('Invalid IP address format');
        }
        
        // Query Cloudflare DoH API
        const dohUrl = `https://cloudflare-dns.com/dns-query?name=${encodeURIComponent(reverseDNS)}&type=PTR`;
        const response = await fetch(dohUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/dns-json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`DNS query failed: ${response.status}`);
        }
        
        return await response.json();
      })();
      
      // Start NS lookup in parallel (don't await yet)
      const nsPromise = lookupAuthoritativeNS(ip);
      
      try {
        const data = await ptrPromise;
        
        // Check if we have an answer
        if (data.Answer && data.Answer.length > 0) {
          const hostname = data.Answer[0].data;
          resultValue.textContent = hostname;
          resultValue.style.color = '';
          resultValue.style.fontStyle = '';
          resultValue.setAttribute('data-hostname', hostname);
          copyBtn.style.display = 'flex';
          resultContainer.style.display = 'block';
        } else {
          resultValue.textContent = 'No reverse DNS record found';
          resultValue.style.color = 'var(--text-muted)';
          resultValue.style.fontStyle = 'italic';
          resultValue.removeAttribute('data-hostname');
          copyBtn.style.display = 'none';
          resultContainer.style.display = 'block';
        }
      } catch (error) {
        resultValue.textContent = 'Lookup failed: ' + error.message;
        resultValue.style.color = 'var(--text-muted)';
        resultValue.style.fontStyle = 'italic';
        resultValue.removeAttribute('data-hostname');
        copyBtn.style.display = 'none';
        resultContainer.style.display = 'block';
      }
      
      // Wait for NS lookup to complete
      await nsPromise;
      
      // Re-enable button
      btn.disabled = false;
      btn.classList.remove('loading');
      btnText.textContent = 'Lookup Reverse DNS';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyHostname() {
      const hostnameValue = document.getElementById('reverse-dns-value');
      const hostname = hostnameValue.getAttribute('data-hostname');
      if (!hostname) {
        return;
      }
      navigator.clipboard.writeText(hostname).then(function() {
        const btn = document.getElementById('reverse-dns-copy-btn');
        btn.classList.add('copied');
        setTimeout(function() {
          btn.classList.remove('copied');
        }, 1500);
      });
    }
  </script>
</body>
</html>

